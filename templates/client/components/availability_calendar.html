<!-- Componente de Calendario de Disponibilidad -->
<div class="availability-calendar" id="availability-calendar-{{ room.id }}">
    <div class="calendar-header">
        <h5 class="fw-bold mb-3">
            <i class="fas fa-calendar-alt me-2"></i>Disponibilidad
        </h5>
        <div class="calendar-legend mb-3">
            <div class="d-flex gap-3 flex-wrap">
                <div class="legend-item">
                    <span class="legend-color available"></span>
                    <small>Disponible</small>
                </div>
                <div class="legend-item">
                    <span class="legend-color occupied"></span>
                    <small>Ocupado</small>
                </div>
                <div class="legend-item">
                    <span class="legend-color today"></span>
                    <small>Hoy</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="calendar-navigation mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-primary btn-sm" id="prev-month-{{ room.id }}">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h6 class="mb-0 fw-bold" id="current-month-{{ room.id }}"></h6>
            <button class="btn btn-outline-primary btn-sm" id="next-month-{{ room.id }}">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="calendar-grid" id="calendar-grid-{{ room.id }}">
        <!-- El calendario se generará dinámicamente con JavaScript -->
        <div class="loading-calendar text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-muted mt-2 mb-0">Cargando disponibilidad...</p>
        </div>
    </div>
    
    <div class="calendar-info mt-3">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Haz clic en una fecha disponible para seleccionarla
        </small>
    </div>
</div>

<style>
.availability-calendar {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.calendar-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    display: inline-block;
}

.legend-color.available {
    background-color: #28a745;
}

.legend-color.occupied {
    background-color: #dc3545;
}

.legend-color.today {
    background-color: #007bff;
    border: 2px solid #0056b3;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
}

.calendar-day-header {
    background: #6c757d;
    color: white;
    padding: 8px 4px;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    border-radius: 4px;
}

.calendar-day {
    background: #fff;
    border: 1px solid #dee2e6;
    padding: 8px 4px;
    text-align: center;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.calendar-day:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.calendar-day.available {
    background-color: #d4edda;
    border-color: #28a745;
    color: #155724;
}

.calendar-day.available:hover {
    background-color: #28a745;
    color: white;
}

.calendar-day.occupied {
    background-color: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
    cursor: not-allowed;
}

.calendar-day.occupied:hover {
    transform: none;
    box-shadow: none;
}

.calendar-day.today {
    background-color: #cce5ff;
    border-color: #007bff;
    color: #004085;
    font-weight: bold;
}

.calendar-day.today.available {
    background-color: #007bff;
    color: white;
}

.calendar-day.other-month {
    color: #6c757d;
    background-color: #f8f9fa;
}

.calendar-day.selected {
    background-color: #007bff;
    color: white;
    border-color: #0056b3;
    font-weight: bold;
}

.loading-calendar {
    grid-column: 1 / -1;
}

@media (max-width: 576px) {
    .availability-calendar {
        padding: 15px;
    }
    
    .calendar-day {
        font-size: 12px;
        min-height: 32px;
        padding: 6px 2px;
    }
    
    .calendar-legend {
        justify-content: center;
    }
}
</style>

<script>
var AvailabilityCalendar = window.AvailabilityCalendar || class AvailabilityCalendar {
    constructor(roomId) {
        this.roomId = roomId;
        this.currentDate = new Date();
        this.selectedDate = null;
        this.availabilityData = {};
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadAvailability();
    }
    
    bindEvents() {
        const prevBtn = document.getElementById(`prev-month-${this.roomId}`);
        const nextBtn = document.getElementById(`next-month-${this.roomId}`);
        
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.renderCalendar();
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.renderCalendar();
            });
        }
    }
    
    async loadAvailability() {
        try {
            const startDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
            const endDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 2, 0);
            
            const response = await fetch(`/portal/room-availability/${this.roomId}/?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
            const data = await response.json();
            
            if (data.availability) {
                this.availabilityData = data.availability;
                this.renderCalendar();
            }
        } catch (error) {
            console.error('Error loading availability:', error);
            this.renderError();
        }
    }
    
    renderCalendar() {
        const grid = document.getElementById(`calendar-grid-${this.roomId}`);
        const monthHeader = document.getElementById(`current-month-${this.roomId}`);
        
        if (!grid || !monthHeader) return;
        
        // Actualizar header del mes
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        monthHeader.textContent = `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
        
        // Limpiar grid
        grid.innerHTML = '';
        
        // Headers de días
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        dayHeaders.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        // Obtener primer día del mes y días en el mes
        const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
        const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
        const today = new Date();
        
        // Días del mes anterior para completar la primera semana
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        // Generar 42 días (6 semanas)
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = date.getDate();
            
            const dateStr = date.toISOString().split('T')[0];
            const isCurrentMonth = date.getMonth() === this.currentDate.getMonth();
            const isToday = date.toDateString() === today.toDateString();
            
            if (!isCurrentMonth) {
                dayElement.classList.add('other-month');
            }
            
            if (isToday) {
                dayElement.classList.add('today');
            }
            
            // Aplicar disponibilidad
            if (this.availabilityData[dateStr]) {
                const availability = this.availabilityData[dateStr];
                if (availability.available) {
                    dayElement.classList.add('available');
                    dayElement.addEventListener('click', () => this.selectDate(date));
                } else {
                    dayElement.classList.add('occupied');
                }
            }
            
            grid.appendChild(dayElement);
        }
    }
    
    selectDate(date) {
        // Remover selección anterior
        const prevSelected = document.querySelector(`#calendar-grid-${this.roomId} .calendar-day.selected`);
        if (prevSelected) {
            prevSelected.classList.remove('selected');
        }
        
        // Seleccionar nueva fecha
        const dateStr = date.toISOString().split('T')[0];
        const dayElements = document.querySelectorAll(`#calendar-grid-${this.roomId} .calendar-day`);
        
        dayElements.forEach(el => {
            if (el.textContent == date.getDate() && !el.classList.contains('other-month')) {
                el.classList.add('selected');
            }
        });
        
        this.selectedDate = date;
        
        // Disparar evento personalizado
        const event = new CustomEvent('dateSelected', {
            detail: { date: date, roomId: this.roomId }
        });
        document.dispatchEvent(event);
    }
    
    renderError() {
        const grid = document.getElementById(`calendar-grid-${this.roomId}`);
        if (grid) {
            grid.innerHTML = `
                <div class="loading-calendar text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <p class="text-muted mt-2 mb-0">Error al cargar disponibilidad</p>
                </div>
            `;
        }
    }
}

// Inicializar calendario cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    const calendars = document.querySelectorAll('[id^="availability-calendar-"]');
    calendars.forEach(calendar => {
        const roomId = calendar.id.split('-').pop();
        new AvailabilityCalendar(roomId);
    });
});
</script>