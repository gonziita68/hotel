{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Superadmin{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color:#2563eb; --secondary-color:#64748b; --accent-color:#f59e0b;
      --success-color:#10b981; --danger-color:#ef4444; --warning-color:#f59e0b; --info-color:#3b82f6;
      --bg-color:#f8fafc; --text-color:#1e293b; --muted-color:#94a3b8; --border-color:#e2e8f0;
      --card-bg:#ffffff; --navbar-gradient-start:#2563eb; --navbar-gradient-end:#1d4ed8;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1),0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    [data-theme="dark"] {
      --bg-color:#0b1220; --text-color:#e5e7eb; --muted-color:#93a4bd; --border-color:#1f2937;
      --card-bg:#0f172a; --navbar-gradient-start:#0b1220; --navbar-gradient-end:#0b1324;
      --primary-color:#3b82f6; --accent-color:#f59e0b;
      --shadow-sm:0 1px 2px 0 rgb(255 255 255 / 0.04);
      --shadow-md:0 4px 6px -1px rgb(255 255 255 / 0.06),0 2px 4px -2px rgb(255 255 255 / 0.04);
      --shadow-lg:0 10px 15px -3px rgb(255 255 255 / 0.06),0 4px 6px -4px rgb(255 255 255 / 0.04);
    }
    body { font-family:'Inter',sans-serif; line-height:1.6; color:var(--text-color); background-color:var(--bg-color); }
    .hero-section { background:linear-gradient(135deg,var(--primary-color) 0%, var(--navbar-gradient-end) 100%); color:#fff; padding:2.5rem 0; position:relative; overflow:hidden; }
    .hero-content { position:relative; z-index:1; }
    .text-gradient { background:linear-gradient(135deg,var(--primary-color) 0%, var(--accent-color) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .client-card { background:var(--card-bg); border-radius:16px; box-shadow:var(--shadow-sm); border:1px solid var(--border-color); transition:box-shadow .2s ease, transform .2s ease; overflow:hidden; }
    .client-card:hover { box-shadow:var(--shadow-lg); transform:translateY(-2px); }
    .room-content { padding:1.25rem 1.5rem; }
    .room-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; }
    .room-title { font-size:1.2rem; font-weight:600; color:var(--dark-color); margin:0; }
    .room-description { color:var(--muted-color); margin-bottom:.75rem; }
    .room-actions { display:flex; gap:.75rem; }
    .status-badge { padding:.5rem .75rem; border-radius:20px; font-size:.75rem; font-weight:600; text-transform:uppercase; }
    .status-available { background-color:rgba(16,185,129,.1); color:var(--success-color); }
    .status-maintenance { background-color:rgba(245,158,11,.1); color:var(--warning-color); }
    .navbar-super { background:linear-gradient(135deg,var(--navbar-gradient-start) 0%, var(--navbar-gradient-end) 100%); }
    .navbar-super .nav-link { color:#fff; opacity:.9; }
    .navbar-super .nav-link:hover { color:#fff; opacity:1; }
    .footer-super { background:var(--card-bg); color:var(--muted-color); padding:2rem 0; margin-top:4rem; border-top:1px solid var(--border-color); }
    .page-section { margin-top:1.25rem; }
    .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem; }
    .kpi-card { padding:1.25rem; text-align:center; }
    .kpi-title { font-weight:600; color:var(--muted-color); margin-bottom:.25rem; }
    .kpi-value { font-size:2rem; font-weight:800; letter-spacing:.5px; }
    .chart-card { padding:1rem; }
    .chart-card canvas { min-height:260px; }
    .toolbar .form-select, .toolbar .form-control { min-width:160px; }
  </style>
  {% block extra_css %}{% endblock %}
  <style>{% block page_css %}{% endblock %}</style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark navbar-super">
    <div class="container">
      <a class="navbar-brand fw-bold" href="{% url 'superadmin_dashboard' %}"><i class="fas fa-shield-halved me-2"></i>Superadmin</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navSuper"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navSuper">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{% url 'superadmin_hotels' %}"><i class="fas fa-hotel me-1"></i>Hoteles</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'superadmin_users' %}"><i class="fas fa-users me-1"></i>Usuarios</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'superadmin_audit_actions' %}"><i class="fas fa-list-check me-1"></i>Acciones</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'superadmin_audit_emails' %}"><i class="fas fa-envelope me-1"></i>Emails</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'superadmin_export_bookings_csv' %}"><i class="fas fa-file-csv me-1"></i>Reportes</a></li>
        </ul>
        <form id="global-filters" class="d-flex align-items-center gap-2 ms-auto">
          <select class="form-select form-select-sm" id="f-hotel" aria-label="Hotel">
            <option value="">Seleccionar hotel…</option>
          </select>
          <input type="date" class="form-control form-control-sm" id="f-desde" aria-label="Desde">
          <input type="date" class="form-control form-control-sm" id="f-hasta" aria-label="Hasta">
          <button class="btn btn-light btn-sm" type="submit"><i class="fas fa-filter me-1"></i>Aplicar</button>
          <button class="btn btn-outline-light btn-sm" type="button" id="theme-toggle"><i class="fas fa-moon me-1"></i>Tema</button>
        </form>
        <span class="navbar-text text-white ms-3">{{ request.user.username }}</span>
      </div>
    </div>
  </nav>
  <div class="container my-4">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
    {% block content %}{% endblock %}
  </div>
  <footer class="footer-super">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">Superadmin • O11CE SaaS</div>
        <div class="col-md-6 text-md-end"><small>© O11CE</small></div>
      </div>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chat-fab{position:fixed;right:24px;bottom:24px;z-index:1050;border:none;border-radius:999px;padding:.8rem 1rem;background:var(--primary-color);color:#fff;box-shadow:var(--shadow-lg)}
    .chat-modal{position:fixed;right:24px;bottom:84px;z-index:1050;width:360px;max-height:60vh;background:var(--card-bg);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-lg);display:none;overflow:hidden}
    .chat-header{padding:.6rem 1rem;background:linear-gradient(135deg,var(--primary-color),var(--navbar-gradient-end));color:#fff;display:flex;justify-content:space-between;align-items:center}
    .chat-body{padding:1rem;overflow-y:auto;max-height:40vh}
    .chat-input{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--border-color)}
    .chat-msg{margin-bottom:.5rem}
    .chat-msg.me{text-align:right}
    .chat-bubble{display:inline-block;padding:.5rem .75rem;border-radius:12px;background:var(--bg-color)}
    [data-theme="dark"] .chat-bubble{background:#0b1324;color:#e5e7eb}
  </style>
  <button id="chat-toggle" class="chat-fab"><i class="fas fa-comments"></i></button>
  <div id="chat-modal" class="chat-modal">
    <div class="chat-header"><span>Chat</span><button id="chat-close" class="btn btn-sm btn-light">×</button></div>
    <div id="chat-body" class="chat-body"></div>
    <div class="chat-input">
      <input id="chat-text" type="text" class="form-control" placeholder="Escribe...">
      <button id="chat-send" class="btn btn-primary">Enviar</button>
    </div>
  </div>
  <script>
    (function(){
      function qp(k){const u=new URL(window.location.href);return u.searchParams.get(k)}
      function setDefaults(){
        const d=document.getElementById('f-desde');
        const h=document.getElementById('f-hasta');
        const qd=qp('desde'); const qh=qp('hasta');
        const today=new Date(); const isoToday=today.toISOString().slice(0,10);
        const past=new Date(today.getTime()-30*24*60*60*1000); const isoPast=past.toISOString().slice(0,10);
        d.value = qd || isoPast; h.value = qh || isoToday;
        const savedTheme=localStorage.getItem('superadmin_theme')||'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const btn=document.getElementById('theme-toggle');
        btn.innerHTML = savedTheme==='dark' ? '<i class="fas fa-sun me-1"></i>Claro' : '<i class="fas fa-moon me-1"></i>Oscuro';
      }
      function submitFilters(e){
        e.preventDefault();
        const d=document.getElementById('f-desde').value;
        const h=document.getElementById('f-hasta').value;
        const hot=document.getElementById('f-hotel').value;
        const u=new URL(window.location.href);
        if(d) u.searchParams.set('desde', d); else u.searchParams.delete('desde');
        if(h) u.searchParams.set('hasta', h); else u.searchParams.delete('hasta');
        if(hot){ window.location.href = `/superadmin/hoteles/${hot}/`+ (u.search ? u.search : ''); } else { window.location.href = u.toString(); }
      }
      function toggleTheme(){
        const cur=document.documentElement.getAttribute('data-theme')||'dark';
        const next = cur==='dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('superadmin_theme', next);
        const btn=document.getElementById('theme-toggle');
        btn.innerHTML = next==='dark' ? '<i class="fas fa-sun me-1"></i>Claro' : '<i class="fas fa-moon me-1"></i>Oscuro';
      }
      document.getElementById('global-filters').addEventListener('submit', submitFilters);
      setDefaults();
      fetch('/superadmin/api/hotels').then(r=>r.json()).then(d=>{const sel=document.getElementById('f-hotel');(d.hotels||[]).forEach(x=>{const o=document.createElement('option');o.value=x.id;o.textContent=x.name+(x.is_blocked?' (Bloqueado)':'');sel.appendChild(o)})})
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      const chatBtn=document.getElementById('chat-toggle');
      const chatMod=document.getElementById('chat-modal');
      const chatClose=document.getElementById('chat-close');
      const chatBody=document.getElementById('chat-body');
      const chatText=document.getElementById('chat-text');
      const chatSend=document.getElementById('chat-send');
      function openChat(){chatMod.style.display='block'}
      function closeChat(){chatMod.style.display='none'}
      function addMsg(text,me){const d=document.createElement('div');d.className='chat-msg'+(me?' me':'');const b=document.createElement('div');b.className='chat-bubble';b.textContent=text;d.appendChild(b);chatBody.appendChild(d);chatBody.scrollTop=chatBody.scrollHeight}
      function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():''}
      async function send(){const t=chatText.value.trim();if(!t)return;addMsg(t,true);chatText.value='';
        const u=new URL(window.location.href);const d=u.searchParams.get('desde')||new Date().toISOString().slice(0,10);const h=u.searchParams.get('hasta')||new Date().toISOString().slice(0,10);
        const hotelId=(document.getElementById('f-hotel').value||'').trim();
        const scope = hotelId? 'hotel':'global';
        const body = { scope: scope, hotel_id: hotelId? Number(hotelId): undefined, desde: d, hasta: h, question: t };
        try{
          const r=await fetch('/superadmin/api/ia/chat/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},body:JSON.stringify(body)});
          const out=await r.json();
          if(!r.ok||out.error){addMsg((out.detail||out.error)||'Error en el análisis',false);return}
          if(out.status==='started'){addMsg('Análisis iniciado en IA. Espera unos segundos y reintenta.',false);return}
          if(out.answer){addMsg(out.answer,false);(out.recommendations||[]).forEach(t=>addMsg('• '+t,false));return}
          addMsg('IA respondió sin contenido utilizable.',false)
        }catch(e){addMsg('Error de red al consultar IA',false)}
      }
      chatBtn.addEventListener('click',openChat);chatClose.addEventListener('click',closeChat);chatSend.addEventListener('click',send);
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>